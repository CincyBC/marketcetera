//
// this file is automatically generated
//
package org.marketcetera.strategy;

import java.util.Collection;
import java.util.concurrent.Callable;

import org.marketcetera.admin.UserFactory;
import org.marketcetera.core.ApplicationVersion;
import org.marketcetera.core.Preserve;
import org.marketcetera.core.Util;
import org.marketcetera.core.VersionInfo;
import org.marketcetera.rpc.base.BaseRpc;
import org.marketcetera.rpc.client.AbstractRpcClient;
import org.marketcetera.util.log.SLF4JLoggerProxy;
import org.marketcetera.util.ws.tags.AppId;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.config.ConfigurableBeanFactory;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Component;

import com.google.common.collect.Lists;

/* $License$ */

/**
 * Provides an RPC Client for StrategyRpc services.
 *
 * @author <a href="mailto:colin@marketcetera.com">Colin DuPlantis</a>
 * @version $Id$
 * @since $Release$
 */
@Preserve
@Component
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
public class StrategyRpcClient
        extends AbstractRpcClient<StrategyRpcServiceGrpc.StrategyRpcServiceBlockingStub,StrategyRpcServiceGrpc.StrategyRpcServiceStub,StrategyRpcClientParameters>
        implements StrategyClient
{
    /* (non-Javadoc)
     * @see StrategyClient#getStrategyInstances()
     */
    @Override
    public Collection<? extends StrategyInstance> getStrategyInstances()
    {
        return executeCall(new Callable<Collection<? extends StrategyInstance>>() {
            @Override
            public Collection<? extends StrategyInstance> call()
                    throws Exception
            {
                StrategyRpc.ReadStrategyInstancesRequest.Builder requestBuilder = StrategyRpc.ReadStrategyInstancesRequest.newBuilder();
                requestBuilder.setSessionId(getSessionId().getValue());
                StrategyRpc.ReadStrategyInstancesRequest request = requestBuilder.build();
                SLF4JLoggerProxy.trace(StrategyRpcClient.this,"{} sending {}",getSessionId(),request);
                StrategyRpc.ReadStrategyInstancesResponse response = getBlockingStub().getStrategyInstances(request);
                SLF4JLoggerProxy.trace(StrategyRpcClient.this,"{} received {}",getSessionId(),response);
                Collection<StrategyInstance> results = Lists.newArrayList();
                response.getStrategyInstancesList().forEach(rpcStrategyInstance -> StrategyRpcUtil.getStrategyInstance(rpcStrategyInstance,
                                                                                                                       strategyInstanceFactory,
                                                                                                                       userFactory).ifPresent(strategyInstance -> results.add(strategyInstance)));
                return results;
            }}
        );
    }
    /* (non-Javadoc)
     * @see StrategyClient#loadStrategyInstance(StrategyInstance)
     */
    @Override
    public StrategyStatus loadStrategyInstance(StrategyInstance inStrategyInstance)
    {
        return executeCall(new Callable<StrategyStatus>() {
            @Override
            public StrategyStatus call()
                    throws Exception
            {
                StrategyRpc.LoadStrategyInstanceRequest.Builder requestBuilder = StrategyRpc.LoadStrategyInstanceRequest.newBuilder();
                requestBuilder.setSessionId(getSessionId().getValue());
                StrategyRpcUtil.getRpcStrategyInstance(inStrategyInstance).ifPresent(rpcValue->requestBuilder.setStrategyInstance(rpcValue));
                StrategyRpc.LoadStrategyInstanceRequest request = requestBuilder.build();
                SLF4JLoggerProxy.trace(StrategyRpcClient.this,"{} sending {}",getSessionId(),request);
                StrategyRpc.LoadStrategyInstanceResponse response = getBlockingStub().loadStrategyInstance(request);
                SLF4JLoggerProxy.trace(StrategyRpcClient.this,"{} received {}",getSessionId(),response);
                return StrategyRpcUtil.getStrategyStatus(response.getStatus()).orElse(null);
            }}
        );
    }
    /* (non-Javadoc)
     * @see AbstractRpcClient#getBlockingStub(io.grpc.Channel)
     */
    @Override
    protected StrategyRpcServiceGrpc.StrategyRpcServiceBlockingStub getBlockingStub(io.grpc.Channel inChannel)
    {
        return StrategyRpcServiceGrpc.newBlockingStub(inChannel);
    }
    /* (non-Javadoc)
     * @see AbstractRpcClient#getAsyncStub(io.grpc.Channel)
     */
    @Override
    protected StrategyRpcServiceGrpc.StrategyRpcServiceStub getAsyncStub(io.grpc.Channel inChannel)
    {
        return StrategyRpcServiceGrpc.newStub(inChannel);
    }
    /* (non-Javadoc)
     * @see AbstractRpcClient#executeLogin(BaseRpc.LoginRequest)
     */
    @Override
    protected BaseRpc.LoginResponse executeLogin(BaseRpc.LoginRequest inRequest)
    {
        return getBlockingStub().login(inRequest);
    }
    /* (non-Javadoc)
     * @see AbstractRpcClient#executeLogout(BaseRpc.LogoutRequest)
     */
    @Override
    protected BaseRpc.LogoutResponse executeLogout(BaseRpc.LogoutRequest inRequest)
    {
        return getBlockingStub().logout(inRequest);
    }
    /* (non-Javadoc)
     * @see AbstractRpcClient#executeHeartbeat(BaseRpc.HeartbeatRequest)
     */
    @Override
    protected BaseRpc.HeartbeatResponse executeHeartbeat(BaseRpc.HeartbeatRequest inRequest)
    {
        return getBlockingStub().heartbeat(inRequest);
    }
    /* (non-Javadoc)
     * @see AbstractRpcClient#getAppId()
     */
    @Override
    protected AppId getAppId()
    {
        return APP_ID;
    }
    /* (non-Javadoc)
     * @see AbstractRpcClient#getVersionInfo()
     */
    @Override
    protected VersionInfo getVersionInfo()
    {
        return APP_ID_VERSION;
    }
    /**
     * Create a new StrategyRpc instance.
     *
     * @param inParameters a <code>StrategyRpcClientParameters</code> value
     */
    protected StrategyRpcClient(StrategyRpcClientParameters inParameters)
    {
        super(inParameters);
    }
    /**
     * creates new {@link StrategyInstance} objects
     */
    @Autowired
    private StrategyInstanceFactory strategyInstanceFactory;
    /**
     * creates new {@link User} objects
     */
    @Autowired
    private UserFactory userFactory;
    /**
     * The client's application ID: the application name.
     */
    public static final String APP_ID_NAME = "StrategyRpc"; //$NON-NLS-1$
    /**
     * The client's application ID: the version.
     */
    public static final VersionInfo APP_ID_VERSION = ApplicationVersion.getVersion(StrategyClient.class);
    /**
     * The client's application ID: the ID.
     */
    public static final AppId APP_ID = Util.getAppId(APP_ID_NAME,APP_ID_VERSION.getVersionInfo());
}
